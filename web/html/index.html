<!DOCTYPE html>
<html lang="en">
<head>
    <title>Code Explainer</title>
    <style type="text/css" media="screen">
        #editor { 
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet">
    <!-- <script src="//ajaxorg.github.io/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script> -->
</head>
<body>

<div id="wrap">
<div id="editor">
function test() {
    // I'm example code
    let x = 0;
    if (x === 0) {
        return x;
    } else if (x == 1){
        return 0;
    } else {
        return 1;
    }
}
</div>
    <div id="display" style="overflow-y:auto; height: 95%;">
        <p>Click on or after a keyword to learn more about it</p>
    </div>
</div>

<script src="src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="js/jquery-3.3.1.js" type="text/javascript" charset="utf-8"></script>
<script>

    const displayDefault = `<p>Click on or after a keyword to learn more about it</p>`;

    // set the display height to change when the window changes
    window.onresize = changeDisplayHeight;
    function changeDisplayHeight() {
        document.querySelector("#display").style.height = window.innerHeight + "px";
    }
    changeDisplayHeight();

    // Get the editor and settings
    var editor = ace.edit("editor");
    editor.setOptions({
        // theme: "ace/theme/idle_fingers",
        theme: "ace/theme/kr_theme",
        showPrintMargin: false
    });

    // Make a not of avaliable languages in the database to accept others
    editor.session.setMode("ace/mode/javascript", tokenizeDocument);
    let tokens = {};
    let rules = {};

    // Goes through the document and tokenizes the whole thing
    function tokenizeDocument() {
        let result = [];    // What we're sending out

        // Iterator over the entire document and collect a token for each value
        var TokenIterator = ace.require("ace/token_iterator").TokenIterator;
        var tokIter = new TokenIterator(editor.session, 0, 0);
        tokIter.stepForward();
        while (tokIter.getCurrentToken()) {
            let next = tokIter.getCurrentToken();
            // set the line where the token occures
            next.line = editor.env.document.doc.getLine(tokIter.getCurrentTokenRow());

            // if we've already pulled the token data, then there's no need to request it again
            if (!tokens[`${next.type}:${next.value}`]){
                result.push(next);
                tokens[`${next.type}:${next.value}`] = next;
            }
            tokIter.stepForward();
        }

        // Request the rules from the server
        requestRules(result);
    }

    function requestRules(tokens) {
        $.ajax({
            method: "GET",
            url: "./get/rules",
            data: {
                tokens: tokens,
                lang: editor.getSession().getMode().$id
            },
            dataType: "JSON"
        }).done(function(data){
            if (data) {
                parseRules(data);
            }
        });
    }

    function parseRules(newRules) {
        Object.keys(newRules).forEach(key => {
            rules[key] = newRules[key];
        });
    }

    editor.on('click', function(e) {
        // *** Have a holder there to determine if we should continue.
        // console.log(editor.session.getAnnotations());
        let pos = e.$pos;
        let sec = editor.session;
        let tolk = sec.getTokenAt(pos.row, pos.column);
        let display = document.querySelector("#display");
        console.log(tolk);
        if (tolk) {
            if (rules[`${tolk.type}:${tolk.value}`]){
                let newHtml = rules[`${tolk.type}:${tolk.value}`].html;
                newHtml.replace(/function/g, 'bubbles');
                display.innerHTML = newHtml;
            } else {
                display.innerHTML = "<p>There is no description of this token:   \"" + tolk.value + "\"</p>";
            }
            highlightCode();
        } else {
            display.innerHTML = "<p>Click on or after a keyword to learn more about it</p>";
        }
    });

    function highlightCode() {
        document.querySelectorAll('code').forEach((block) => {
            hljs.highlightBlock(block);
        });
    }

    editor.on('change', tokenizeDocument);

</script>
<link rel="stylesheet" href="../highlight/styles/darkula.css">
<script src="../highlight/highlight.pack.js"></script>
<style>
    #wrap {
        display: inline-block;
        width: 100%;
        height: 90%;
    }
    #display {
        background: #e3e3e3;
        width: 20%;
        min-height: 100%;
        margin: auto;
        margin-top: 4px;
        margin-right: 15%;
        padding: 1.5em 1.5em;
        font-family: 'Fira Sans', sans-serif;
        text-align: left;
    }
    code {
        padding: 0em 1em;
        /* border: 1px solid #141414; */
        border-radius: 5px;
        overflow-x: auto;
    }
    #editor-wrap {
        height: 1em;
        max-width: 600px;
    }
    #editor {
        width: 45%;
        margin: auto;
        margin-top: 1em;
        margin-right: 39%;
    }
    body {
        background: black;
    }
</style>
</body>
</html>